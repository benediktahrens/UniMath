# -*- makefile-gmake -*-
COQBIN?=$(shell pwd)/sub/coq/bin/
ifeq ("$(shell test -f build/Makefile-configuration && echo yes)",yes)
include build/Makefile-configuration
endif
BUILD_COQ ?= yes
ifeq ($(BUILD_COQ),yes)
all: build-coq
endif
include build/Makefile-coq.make
# packages, listed in reverse order:
PACKAGES = Ktheory RezkCompletion Foundations
everything: TAGS all html install
OTHERFLAGS += -indices-matter
UniMath/Foundations/hlevel2/algebra1b.vo : OTHERFLAGS += -no-sharing
ifeq ($(VERBOSE),yes)
OTHERFLAGS += -verbose
endif
# later: see exactly which files need -no-sharing
NO_SHARING = yes
ifeq ($(NO_SHARING),yes)
OTHERFLAGS += -no-sharing
endif
# TIME = time
COQDOC := $(COQDOC) -utf8
COQC = $(TIME) $(COQBIN)coqc
COQDEFS := --language=none -r '/^[[:space:]]*\(Axiom\|Theorem\|Class\|Instance\|Let\|Ltac\|Definition\|Lemma\|Record\|Remark\|Structure\|Fixpoint\|Fact\|Corollary\|Let\|Inductive\|Coinductive\|Notation\|Proposition\|Module[[:space:]]+Import\|Module\)[[:space:]]+\([[:alnum:]'\''_]+\)/\2/'
TAGS : $(VFILES); etags $(COQDEFS) $^
install:all
lc:; wc -l $(VFILES)
wc:; wc -w $(VFILES)
clean:clean2
clean2:; find . \( -name .\*.aux \) -delete
describe:; git describe --dirty --long --always --abbrev=40 --all
publish-dan:html; rsync -ai html/. u00:public_html/Ktheory/.
.package-files: $(patsubst %, UniMath/%/.package/files, $(PACKAGES))
	@ echo making $@ ; ( \
	echo '# -*- makefile-gmake -*-' ;\
	echo ;\
	echo '# DO NOT EDIT THIS FILE!' ;\
	echo '# It is made by Makefile' ;\
	echo ;\
	echo '-R UniMath UniMath' ;\
	echo ;\
	for i in $(PACKAGES) ;\
	do sed "s=^=UniMath/$$i/=" < UniMath/$$i/.package/files ;\
	done ;\
	echo ;\
	echo '# Local ''Variables:' ;\
	echo '# compile-command: "sub/coq/bin/coq_makefile -f .package-files -o Makefile-coq.make.tmp && mv Makefile-coq.make.tmp build/Makefile-coq.make"' ;\
	echo '# End:' ;\
	) >$@
# the '' above prevents emacs from mistaking the lines above as providing local variables when visiting this file
always:
ifeq ($(REMAKE_FILES),yes)
.package-files:always
endif
build/Makefile-coq.make: .package-files
	coq_makefile -f .package-files -o Makefile-coq.make.tmp && mv Makefile-coq.make.tmp build/Makefile-coq.make

# building coq:
export PATH:=$(shell pwd)/sub/coq/bin:$(PATH)
build-coq: sub/coq/configure sub/coq/config/coq_config.ml sub/coq/bin/coqc
sub/coq/configure:
	git submodule update --init sub/coq
sub/coq/config/coq_config.ml: sub/coq/configure.ml
	cd sub/coq && ./configure -coqide no -opt -no-native-compiler -with-doc no -annotate -debug -local
sub/coq/bin/coqc:
	make -C sub/coq KEEP_ML4_PREPROCESSED=true VERBOSE=true READABLE_ML4=yes coqlight
